name: Selenium NUnit - CI

on:
  push:
    branches: [ "develop", "main", "master" ]
  pull_request:
    branches: [ "develop", "main", "master" ]
  workflow_dispatch:

jobs:
  tests:
    runs-on: windows-latest

    env:
      BROWSER: chrome
      HEADLESS: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore NuGet packages (packages.config)
        run: nuget restore .\AutomatedTestProjectRaviWebsite.sln

      - name: Build solution
        run: msbuild .\AutomatedTestProjectRaviWebsite.sln /p:Configuration=Release

      - name: Install VSTest
        uses: darenm/Setup-VSTest@v1

      # Downloads a compatible ChromeDriver for the Chrome version installed in the runner
      # and adds it to PATH so Selenium can find it.
      - name: Setup ChromeDriver (match installed Chrome)
        shell: pwsh
        run: |
          $chromeExe = "C:\Program Files\Google\Chrome\Application\chrome.exe"
          if (-not (Test-Path $chromeExe)) { throw "Chrome executable not found at $chromeExe" }

          $chromeVersion = (Get-Item $chromeExe).VersionInfo.ProductVersion
          Write-Host "Chrome version: $chromeVersion"

          $jsonUrl = "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json"
          $json = Invoke-RestMethod $jsonUrl

          $driverUrl = $json.channels.Stable.downloads.chromedriver |
            Where-Object { $_.platform -eq "win64" } |
            Select-Object -ExpandProperty url

          if (-not $driverUrl) { throw "Could not resolve ChromeDriver download URL." }

          Write-Host "Downloading ChromeDriver: $driverUrl"
          $zip = Join-Path $env:RUNNER_TEMP "chromedriver.zip"
          Invoke-WebRequest -Uri $driverUrl -OutFile $zip

          $dest = Join-Path $env:RUNNER_TEMP "chromedriver"
          Expand-Archive -Path $zip -DestinationPath $dest -Force

          $driver = Get-ChildItem $dest -Recurse -Filter "chromedriver.exe" | Select-Object -First 1
          if (-not $driver) { throw "chromedriver.exe not found after extraction." }

          Copy-Item $driver.FullName (Join-Path $env:RUNNER_TEMP "chromedriver.exe") -Force

          # Put chromedriver.exe on PATH for the next steps
          $env:RUNNER_TEMP | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          Write-Host "ChromeDriver ready at: $(Join-Path $env:RUNNER_TEMP 'chromedriver.exe')"

      - name: Run tests (VSTest)
        timeout-minutes: 20
        run: |
          vstest.console.exe .\AutomatedTestProjectRaviWebsite\bin\Release\AutomatedTestProjectRaviWebsite.dll /Logger:"trx;LogFileName=test_results.trx" /ResultsDirectory:TestResults /Diag:TestResults\vstest-diag.log

      - name: Upload test results (trx)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestResults/**/*.trx
          if-no-files-found: ignore

      - name: Upload VSTest diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vstest-diag
          path: TestResults/vstest-diag.log
          if-no-files-found: ignore

      - name: Upload Selenium artifacts (screenshots)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: selenium-artifacts
          path: |
            **/artifacts/*.png
          if-no-files-found: ignore
